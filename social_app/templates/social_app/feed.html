{% extends 'social_app/base.html' %}
{% load static %}

{% block title %}Feed - SocialHub{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; width: 100%;">

    <!-- Welcome Header -->
    <div class="feed-header">
        <h1 class="text-gradient" style="font-size: 3rem; margin-bottom: 0.5rem;">Social Stream</h1>
        <p class="text-muted" style="font-size: 1.1rem; margin-bottom: 2rem;">
            {% if feed_type == 'following' %}
            Posts from people you follow
            {% else %}
            Discover what's happening around the world
            {% endif %}
        </p>

        <!-- Feed Type Toggle -->
        <div class="flex-center gap-3">
            <a href="{% url 'feed' %}"
                class="btn btn-pill {% if feed_type != 'following' %}btn-primary{% else %}btn-outline{% endif %}">
                <ion-icon name="planet-outline"></ion-icon>
                Global Feed
            </a>
            <a href="{% url 'following_feed' %}"
                class="btn btn-pill {% if feed_type == 'following' %}btn-primary{% else %}btn-outline{% endif %}">
                <ion-icon name="people-outline"></ion-icon>
                Following
            </a>
        </div>
    </div>

    <!-- Posts Feed -->
    <div class="feed-grid"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem;">
        {% for post in posts %}
        <article class="stellar-card post-card reveal-{{ forloop.counter|slice:':2' }}" style="padding: 0;">

            <!-- Post Header -->
            <div style="padding: 1.25rem; border-bottom: 1px solid var(--glass-border);" class="flex-between">
                <div class="flex-center gap-3">
                    <div class="avatar-wrapper">
                        {% if post.user.profile.avatar %}
                        <img src="{{ post.user.profile.avatar.url }}" alt="{{ post.user.username }}" class="avatar">
                        {% else %}
                        <div class="avatar flex-center"
                            style="background: var(--primary); font-weight: bold; font-size: 1.2rem; color: white;">
                            {{ post.user.username|slice:":1"|upper }}
                        </div>
                        {% endif %}
                    </div>
                    <div>
                        <h4 class="mb-1">
                            <a href="{% url 'profile' post.user.username %}" class="btn-ghost"
                                style="padding: 0; display: inline; font-size: 1.1rem;">
                                {{ post.user.username }}
                                {% if post.user.profile.is_verified %}
                                <ion-icon name="checkmark-circle" class="text-secondary"
                                    style="font-size: 1rem; vertical-align: middle;"></ion-icon>
                                {% endif %}
                            </a>
                        </h4>
                        <p class="text-muted" style="font-size: 0.8rem;">
                            {{ post.created_at|date:"M d, Y" }}
                            {% if post.is_pinned %}
                            <ion-icon name="pin" class="text-accent" style="margin-left: 8px;"></ion-icon>
                            {% endif %}
                        </p>
                    </div>
                </div>

                <!-- Post Menu -->
                {% if post.user == user %}
                <div class="dropdown" style="position: relative;">
                    <button onclick="toggleDropdown('{{ post.id }}')" class="btn-ghost"
                        style="padding: 8px; border-radius: 50%;">
                        <ion-icon name="ellipsis-horizontal" style="font-size: 1.2rem;"></ion-icon>
                    </button>
                    <div id="dropdown-{{ post.id }}" class="stellar-card"
                        style="display: none; position: absolute; right: 0; top: 110%; padding: 0.5rem; min-width: 140px; z-index: 100;">
                        <a href="{% url 'toggle_pin_post' post.id %}" class="btn btn-ghost"
                            style="width: 100%; justify-content: flex-start; padding: 0.5rem 1rem;">
                            <ion-icon name="pin-outline"></ion-icon> {% if post.is_pinned %}Unpin{% else %}Pin{% endif %}
                        </a>
                        <a href="{% url 'delete_post' post.id %}" class="btn btn-ghost text-accent"
                            style="width: 100%; justify-content: flex-start; padding: 0.5rem 1rem;">
                            <ion-icon name="trash-outline"></ion-icon> Delete
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Post Content -->
            <div style="padding: 1.5rem;">
                <div style="font-size: 1.05rem; line-height: 1.5; color: var(--text-main); margin-bottom: 1rem;">{{ post.content_html|safe }}</div>

                {% if post.image %}
                <div class="post-media">
                    <img src="{{ post.image.url }}" alt="Post image">
                </div>
                {% elif post.video %}
                <div class="post-media">
                    <video src="{{ post.video.url }}" controls
                        style="width: 100%; border-radius: var(--radius-md);"></video>
                </div>
                {% endif %}

                <!-- Hashtags -->
                {% if post.hashtags.all %}
                <div class="flex-center" style="justify-content: flex-start; gap: 0.75rem; margin-top: 1.25rem;">
                    {% for hashtag in post.hashtags.all %}
                    <a href="{% url 'hashtag_view' hashtag.name %}" class="text-secondary"
                        style="font-weight: 500; font-size: 0.9rem;">
                        #{{ hashtag.name }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Post Actions -->
            <div class="post-actions"
                style="padding: 1rem 1.5rem; background: hsla(var(--h-primary), 91%, 60%, 0.03); margin-top: 0; border: none;">
                <a href="{% url 'like_post_toggle' post.id %}"
                    class="action-btn {% if post.is_liked_by_user %}liked{% endif %}">
                    <ion-icon name="heart{% if post.is_liked_by_user %}{% else %}-outline{% endif %}"
                        style="font-size: 1.4rem;"></ion-icon>
                    <span>{{ post.likes.count }}</span>
                </a>
                <a href="{% url 'post_detail' post.id %}" class="action-btn">
                    <ion-icon name="chatbubble-outline" style="font-size: 1.4rem;"></ion-icon>
                    <span>{{ post.comments.count }}</span>
                </a>
            </div>

            <!-- Simple Comment Preview -->
            {% if post.comments.count > 0 %}
            <div
                style="padding: 0.75rem 1rem; border-top: 1px solid var(--glass-border); background: hsla(var(--h-primary), 91%, 60%, 0.015);">
                {% for comment in post.comments.all|slice:":1" %}
                <div style="font-size: 0.85rem; display: flex; align-items: baseline; gap: 0.5rem;">
                    <strong class="text-secondary" style="white-space: nowrap;">{{ comment.user.username }}</strong>
                    <span class="text-muted" style="line-height: 1.4;">{{ comment.text|urlize|linebreaksbr }}</span>
                </div>
                {% endfor %}
                {% if post.comments.count > 1 %}
                <a href="{% url 'post_detail' post.id %}" class="text-dim"
                    style="font-size: 0.8rem; display: block; margin-top: 0.5rem;">
                    View all {{ post.comments.count }} comments
                </a>
                {% endif %}
            </div>
            {% endif %}

        </article>
        {% empty %}
        <div class="stellar-card text-center" style="grid-column: 1 / -1; padding: 4rem 2rem;">
            <ion-icon name="sparkles-outline"
                style="font-size: 4rem; color: var(--text-dim); margin-bottom: 1.5rem;"></ion-icon>
            <h2 class="mb-2">The stream is empty...</h2>
            <p class="text-muted mb-4">Be the one to start the conversation.</p>
            <a href="{% url 'post_create' %}" class="btn btn-primary btn-pill">
                <ion-icon name="add-outline"></ion-icon> Create First Post
            </a>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="flex-center" style="margin-top: 3rem;">
        <div class="stellar-card flex-center gap-3" style="padding: 0.75rem 1.5rem; border-radius: var(--radius-full);">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="btn-ghost"
                style="padding: 8px; border-radius: 50%;">
                <ion-icon name="chevron-back-outline"></ion-icon>
            </a>
            {% endif %}

            <span class="text-muted" style="font-weight: 500;">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="btn-ghost" style="padding: 8px; border-radius: 50%;">
                <ion-icon name="chevron-forward-outline"></ion-icon>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    function toggleDropdown(postId) {
        // Close all other dropdowns first
        document.querySelectorAll('[id^="dropdown-"]').forEach(menu => {
            if (menu.id !== `dropdown-${postId}`) menu.style.display = 'none';
        });
        const dropdown = document.getElementById(`dropdown-${postId}`);
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function (event) {
        if (!event.target.closest('.dropdown')) {
            document.querySelectorAll('[id^="dropdown-"]').forEach(menu => {
                menu.style.display = 'none';
            });
        }
    });
</script>
{% endblock %}